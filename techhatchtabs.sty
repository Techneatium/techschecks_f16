%=================================================================
% MIT LICENSE
%=================================================================
% Copyright (c) 2022 Techneatium
%
% Permission is hereby granted, free of charge, to any person obtaining a copy
% of this software and associated documentation files (the "Software"), to deal
% in the Software without restriction, including without limitation the rights
% to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
% copies of the Software, and to permit persons to whom the Software is
% furnished to do so, subject to the following conditions:
%
% The above copyright notice and this permission notice shall be included in all
% copies or substantial portions of the Software.
%
% THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
% IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
% FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
% AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
% LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
% OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
% SOFTWARE.
%=================================================================
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{techhatchtabs}[2023/01/01]


\RequirePackage{etoolbox} % Boolean and if/else
\RequirePackage{tikz} % shapes, figures
\RequirePackage{tikzpagenodes} % points for tikz
\usetikzlibrary{calc} % used for hyperlinked nodes
\RequirePackage[hidelinks]{hyperref} % used for hyperlinked nodes
\RequirePackage{atbegshi}  % special commands that apply tikz to all pages

\RequirePackage{xkeyval} % allows defining keys for macros


% TODO hacky, relies on being loaded after lengths defined, 
% maybe pass as options

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% OPTIONS / KEYS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% WHY XKEYVAL?
% else if default option sets toggle to true, no good way to
% set value back to false

% \define@boolkey{family}[mp]{key}[default][func] produces a 
% boolean \if<mp><key>, here <mp> is defined as <KV@hatchtabs@> 
% to duplicate standard boolean key naming where 
% <family> = <hatchtabs>, we must define 
% <family> = <packagename.sty> to get \ExecuteOptionsX to work, 
% but still wanted default key names

% if true then tabs are square and white text on black fill
% creates KV@hatchtabs@squaretabs
\define@boolkey{techhatchtabs.sty}[KV@hatchtabs@]{squaretabs}[true]{}

% if true then thumbtabs are 'indented'
% i.e can be cut out from edge of page
\define@boolkey{techhatchtabs.sty}[KV@hatchtabs@]{thumbtabindent}[true]{}

% if true then thumbnars are 'indented' by tabwidth
\define@boolkey{techhatchtabs.sty}[KV@hatchtabs@]{thumbnarindent}[true]{}

% if true then matching node on page after thumbtab is generated
\define@boolkey{techhatchtabs.sty}[KV@hatchtabs@]{autothumbback}[true]{}

% if true activates all page rounding
\define@boolkey{techhatchtabs.sty}[KV@hatchtabs@]{round}[true]{}

% Error handling for unknown options
\DeclareOptionX*{\PackageWarning{techhatchtabs}{‘\CurrentOption’ ignored}}

\ExecuteOptionsX{thumbtabindent, autothumbback, thumbnarindent, round}
\ProcessOptionsX\relax

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% PROCESS OPTIONS / KEYS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%-----------------------------------------------------------------
% TABBING
%-----------------------------------------------------------------

% 'normal' rounded thumbtabs
\tikzset{
    thumbtabnode/.style={
        rectangle,
        anchor=south west,
        rotate=270,
        minimum height=\tabdepth,
        minimum width=\tabwidth,
    },
    thumbbacknode/.style={
        rectangle,
        anchor=south east,
        rotate=90,
        minimum height=\tabdepth,
        minimum width=\tabwidth,
    },
}

\ifKV@hatchtabs@squaretabs
    % filled in square tabs
    \tikzset{
        thumbtabnode/.style={
            rectangle,
            anchor=south west,
            rotate=270,
            minimum height=\tabdepth,
            minimum width=0.98\tabwidth,
            fill=color1,
        },
        thumbbacknode/.style={
            rectangle,
            anchor=south east,
            rotate=90,
            minimum height=\tabdepth,
            minimum width=0.98\tabwidth,
            fill=color1,
        },
    }
\fi 



%-----------------------------------------------------------------
% ROUNDING
%-----------------------------------------------------------------
% variables for controlling rounding diameters in each corner
\newlength{\nwround}
\newlength{\neround}
\newlength{\seround}
\newlength{\swround}
\setlength\nwround{10mm}
\setlength\neround{10mm}
\setlength\seround{10mm}
\setlength\swround{10mm}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% TIKZPICTURE COMMANDS 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%-----------------------------------------------------------------
% HATCHING
%-----------------------------------------------------------------
% creates node option to create hyperref
\tikzset{
	hyperref node/.style={
		alias=sourcenode,
		append after command={
			let     \p1 = (sourcenode.north west),
			\p2=(sourcenode.south east),
			\n1={\x2-\x1},
			\n2={\y1-\y2} in
			node [inner sep=0pt, outer sep=0pt,anchor=north west,at=(\p1)] {\hyperref[#1]{\XeTeXLinkBox{\phantom{\rule{\n1}{\n2}}}}}
			%xelatex needs \XeTeXLinkBox, won't create a link unless it
			%finds text --- rules don't work without \XeTeXLinkBox.
			%Still builds correctly with pdflatex and lualatex
		}
	}
}
% titlepage chevron indentation

% creates individual hatch line (parallelogram)
\newcommand{\single}[1]{
	\fill[color1]
	([xshift=#1*2*5mm,yshift=2mm]current page text area.north west) --
	([xshift=#1*2*5mm+20mm,yshift=20mm+2mm]current page text area.north west) --
	([xshift=#1*2*5mm+25mm,yshift=20mm+2mm]current page text area.north west) --
	([xshift=#1*2*5mm+5mm,yshift=2mm]current page text area.north west) --
	cycle;
}

% while loop to make many parallelograms
\newcommand\Hatch{
	\begin{tikzpicture}[remember picture,overlay]
	\newcount\foo
	\foo=-3
	\loop
	\single{\the\foo}
	\advance \foo +1
	\ifnum \foo<21
	\repeat
	% makes hatched area hyperlink to front page
	\node[
		rectangle,
		hyperref node=frontpage,
		anchor=north,
		minimum width=\paperwidth,
		minimum height=10mm
	]()at ([yshift=\paperheight/2]current page.center) {};
	\end{tikzpicture}
}

%-----------------------------------------------------------------
% ROUNDING - HIGH LEVEL
%-----------------------------------------------------------------

% thumbtab for Section page
\newcommand{\thumbtab}[2]{
    \ifKV@hatchtabs@round
        \ifKV@hatchtabs@thumbtabindent
            % if indent then create cutline around tab
            \@RoundFillNW
            \@TabFillNE{\tabdepth}{#2}
            \@TabFrame{\tabdepth}{#2}
        \else
            % else thumbwide
            \@RoundFillNW
            \@RoundFillNE{0mm}
            \@RoundFrame{0mm}
        \fi
    \fi
    \begin{tikzpicture}[remember picture, overlay]
    \node[
        thumbtabnode,
    ]
    (sectionnode) at ([xshift=1\outmar-\tabdepth, yshift=-#2*\tabwidth]current page text area.north east){
        \ifKV@hatchtabs@squaretabs
            \color{white}\small\titlefont\textbf{#1}
        \else
            \small\textbf{#1}
        \fi
    };
    \end{tikzpicture}
	% create label for hyperlinks on front page
	\label{thumbtab:#2}
	% create node on back of page
	\AtBeginShipoutNext{\thumbback{#1}{#2}}
}

% node with section name without border
\newcommand{\thumbback}[2]{
	\ifKV@hatchtabs@autothumbback
		\begin{tikzpicture}[remember picture, overlay]
		\node[
			thumbbacknode,
		]
		(sectionnode) at ([xshift=-1\outmar+\tabdepth, yshift=-#2*\tabwidth]current page text area.north west) {
        \ifKV@hatchtabs@squaretabs
            \color{white}\small\titlefont\textbf{#1}
        \else
            \small\textbf{#1}
        \fi
		};
		\end{tikzpicture}
	\fi
}

% rounds all 4 corners, for front page and back page
\newcommand{\thumbwide}{
	\ifKV@hatchtabs@round
        \@RoundFillNW
        \@RoundFillNE{0mm}
        \@RoundFillSE
        \@RoundFrame{0mm}
	\fi
}

% rounds all 4 corners, removes width from outer edge
% for all pages that are not front-, back- or section-page
\newcommand{\thumbnar}{
	\ifKV@hatchtabs@round
        \ifKV@hatchtabs@thumbnarindent
            \@RoundFillNW
            \@RoundFillNE{\tabdepth}
            \@RoundFrame{\tabdepth}
        \else 
            \@RoundFillNW
            \@RoundFillNE{0mm}
            \@RoundFrame{0mm}
        \fi
	\fi
}

%-----------------------------------------------------------------
% ROUNDING - LOW LEVEL
%-----------------------------------------------------------------

% fills in outside of rounded NW corner with white
\newcommand{\@RoundFillNW}{
    \begin{tikzpicture}[remember picture, overlay]
		% north west corner
		\fill[white]
			([xshift=-\inmar, yshift=\topmar]current page text area.north west) --
			([xshift=-\inmar, yshift=\topmar-10mm]current page text area.north west)
			[rounded corners=\nwround] --
			([xshift=-\inmar, yshift=\topmar]current page text area.north west) --
			([xshift=-\inmar+10mm, yshift=\topmar]current page text area.north west)
			[sharp corners] --
			cycle;
    \end{tikzpicture}
}

% fills in ouside of rounded NE corner + indentation with white
\newcommand{\@RoundFillNE}[1]{
    \begin{tikzpicture}[remember picture, overlay]
		% arg is indentation, \tabdepth for thumbnar
		\fill[white]
			([xshift=\outmar, yshift=\topmar]current page text area.north east) --
			([xshift=\outmar, yshift=\topmar-10mm]current page text area.north east) --
			([xshift=\outmar-#1, yshift=\topmar-10mm]current page text area.north east)
			[rounded corners=\neround] --
			([xshift=\outmar-#1, yshift=\topmar]current page text area.north east) --
			([xshift=\outmar-#1-10mm, yshift=\topmar]current page text area.north east)
			[sharp corners] --
			cycle;
    \end{tikzpicture}
}

% fills in ouside of rounded SE corner with white
\newcommand{\@RoundFillSE}{
    \begin{tikzpicture}[remember picture, overlay]
		\fill[white]
            ([xshift=\outmar, yshift=-\botmar]current page text area.south east) --
            ([xshift=\outmar, yshift=-\botmar+10mm]current page text area.south east)
            [rounded corners=\seround] --
            ([xshift=\outmar, yshift=-\botmar]current page text area.south east) --
            ([xshift=\outmar-10mm, yshift=-\botmar]current page text area.south east)
            [sharp corners] --
            cycle;
    \end{tikzpicture}
}

% draws rounded line around page with indentation on outer edge
\newcommand{\@RoundFrame}[1]{
    \begin{tikzpicture}[remember picture, overlay]
		% arg is indentation, \tabdepth for thumbnar
		\draw[color1]
			([xshift=-\inmar, yshift=\topmar]current page text area.north west) [rounded corners = \swround] --
			([xshift=-\inmar, yshift=-\botmar]current page text area.south west) [rounded corners = \seround] --
			([xshift=\outmar-#1, yshift=-\botmar]current page text area.south east) [rounded corners = \neround] --
			([xshift=\outmar-#1, yshift=\topmar]current page text area.north east) [rounded corners = \nwround]--
			cycle;
    \end{tikzpicture}
}

% fills area outside of NE corner for rounded thumbtabs
\newcommand{\@TabFillNE}[2]{
    \begin{tikzpicture}[remember picture, overlay]
		% 1st arg is indentation -> \tabdepth
        % 2nd arg is tab int
		\fill[white]
            ([xshift=\outmar, yshift=-#2*\tabwidth-5mm]current page text area.north east)
            [rounded corners=4mm] --
            ([xshift=\outmar, yshift=-#2*\tabwidth]current page text area.north east)
            [rounded corners=3mm] --
            ([xshift=\outmar-#1, yshift=-#2*\tabwidth]current page text area.north east)
            [rounded corners=\neround] --
            ([xshift=\outmar-#1, yshift=\topmar]current page text area.north east) --
            ([xshift=\outmar-#1-10mm, yshift=\topmar]current page text area.north east)
            [sharp corners]--
            ([xshift=\outmar, yshift=\topmar]current page text area.north east)--
            cycle;
    \end{tikzpicture}
}

% draws frame around page including indentation & thumbtab
\newcommand{\@TabFrame}[2]{
    \begin{tikzpicture}[remember picture, overlay]
		% 1st arg is indentation -> \tabdepth
        % 2nd arg is tab int
		\draw[color1]
            ([xshift=-\inmar, yshift=\topmar]current page text area.north west)
            [rounded corners=\swround] --
            ([xshift=-\inmar, yshift=-\botmar]current page text area.south west)
            [rounded corners=\seround] --
            ([xshift=\outmar, yshift=-\botmar]current page text area.south east)
            [rounded corners=4mm] --
            ([xshift=\outmar, yshift=-#2*\tabwidth]current page text area.north east)
            [rounded corners=3mm] --
            ([xshift=\outmar-#1, yshift=-#2*\tabwidth]current page text area.north east)
            [rounded corners=\neround] --
            ([xshift=\outmar-#1, yshift=\topmar]current page text area.north east)
            [rounded corners=\nwround]--
            cycle;
    \end{tikzpicture}
}

%-----------------------------------------------------------------
% FRONT PAGE
%-----------------------------------------------------------------

\newlength{\chevout} % sets for right side of chevron
\newlength{\chevpoint} % sets point of chevron
\setlength\chevout{\outmar-12mm}
\setlength\chevpoint{\outmar-5mm}
% chevron height is set by tabwidth so it lines up

% creates hyperlinked white chevron with section name
\newcommand{\thumbfront}[2]{
	\begin{tikzpicture}[remember picture,overlay]
	%white chevrons
	\fill[white]
		([xshift=\chevin,
		yshift=-(#2+0.5)*\tabwidth+(\tabwidth/2-2.5mm)
		]current page text area.north east) --
		([xshift=\chevout,
		yshift=-(#2+0.5)*\tabwidth+(\tabwidth/2-2.5mm)
		]current page text area.north east) --
		([xshift=\chevpoint,
		yshift=-(#2+0.5)*\tabwidth
		]current page text area.north east) --
		([xshift=\chevout,
		yshift=-(#2+0.5)*\tabwidth-(\tabwidth/2-2.5mm)
		]current page text area.north east) --
		([
		xshift=\chevin,
		yshift=-(#2+0.5)*\tabwidth-(\tabwidth/2-2.5mm)
		]current page text area.north east) --
		cycle;
	% hyperlinked node for each section
	% uses a number (thumbtab:#2) as label
	\node[
		rectangle,
		anchor=west,
		rotate=0,
		minimum width=20mm,
		minimum height=\tabwidth-5mm,
		hyperref node=thumbtab:#2
	](Procedure) at ([xshift=\chevin, yshift=-(#2+0.5)*\tabwidth]current page text area.north east) {
		\textbf{#1}
	};
	\end{tikzpicture}
}