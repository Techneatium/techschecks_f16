%=================================================================
% MIT LICENSE
%=================================================================
% Copyright (c) 2022 Techneatium
%
% Permission is hereby granted, free of charge, to any person obtaining a copy
% of this software and associated documentation files (the "Software"), to deal
% in the Software without restriction, including without limitation the rights
% to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
% copies of the Software, and to permit persons to whom the Software is
% furnished to do so, subject to the following conditions:
%
% The above copyright notice and this permission notice shall be included in all
% copies or substantial portions of the Software.
%
% THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
% IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
% FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
% AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
% LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
% OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
% SOFTWARE.
%=================================================================
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{techhatchtabs}[2023/01/01]


\RequirePackage{etoolbox} % Boolean and if/else
\RequirePackage{tikz} % shapes, figures
\RequirePackage{tikzpagenodes} % points for tikz
\usetikzlibrary{calc} % used for hyperlinked nodes
\RequirePackage[hidelinks]{hyperref} % used for hyperlinked nodes
\RequirePackage{atbegshi}  % special commands that apply tikz to all pages

\RequirePackage{xkeyval} % allows defining keys for macros


% TODO hacky, relies on being loaded after lengths defined, 
% maybe pass as options


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% TIKZ STYLES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\tikzset{
	thumbtabnode/.style={
        rectangle,
        anchor=south west,
        rotate=270,
        minimum height=\tabdepth,
        minimum width=\tabwidth,
	},
    thumbbacknode/.style={
        rectangle,
        anchor=south east,
        rotate=90,
        minimum height=\tabdepth,
        minimum width=\tabwidth,
	},
}


%-----------------------------------------------------------------
% ROUNDING
%-----------------------------------------------------------------
% variables for controlling rounding diameters in each corner
\newlength{\nwround}
\newlength{\neround}
\newlength{\seround}
\newlength{\swround}
\setlength\nwround{10mm}
\setlength\neround{10mm}
\setlength\seround{10mm}
\setlength\swround{10mm}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% TIKZPICTURE COMMANDS 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%-----------------------------------------------------------------
% HATCHING
%-----------------------------------------------------------------
% creates node option to create hyperref
\tikzset{
	hyperref node/.style={
		alias=sourcenode,
		append after command={
			let     \p1 = (sourcenode.north west),
			\p2=(sourcenode.south east),
			\n1={\x2-\x1},
			\n2={\y1-\y2} in
			node [inner sep=0pt, outer sep=0pt,anchor=north west,at=(\p1)] {\hyperref[#1]{\XeTeXLinkBox{\phantom{\rule{\n1}{\n2}}}}}
			%xelatex needs \XeTeXLinkBox, won't create a link unless it
			%finds text --- rules don't work without \XeTeXLinkBox.
			%Still builds correctly with pdflatex and lualatex
		}
	}
}
% titlepage chevron indentation

% individual parallelogram
\newcommand{\single}[1]{
	\fill[color1]
	([xshift=#1*2*5mm,yshift=2mm]current page text area.north west) --
	([xshift=#1*2*5mm+20mm,yshift=20mm+2mm]current page text area.north west) --
	([xshift=#1*2*5mm+25mm,yshift=20mm+2mm]current page text area.north west) --
	([xshift=#1*2*5mm+5mm,yshift=2mm]current page text area.north west) --
	cycle;
}
% while loop to make many parallelograms
\newcommand\Hatch{
	\begin{tikzpicture}[remember picture,overlay]
	\newcount\foo
	\foo=-3
	\loop
	\single{\the\foo}
	\advance \foo +1
	\ifnum \foo<21
	\repeat
	% makes hatched area hyperlink to front page
	\node[
		rectangle,
		hyperref node=frontpage,
		anchor=north,
		minimum width=\paperwidth,
		minimum height=10mm
	]()at ([yshift=\paperheight/2]current page.center) {};
	\end{tikzpicture}
}

%-----------------------------------------------------------------
% ROUNDING
%-----------------------------------------------------------------
% variables for controlling rounding diameters in each corner
\newlength{\nwround}
\newlength{\neround}
\newlength{\seround}
\newlength{\swround}
\setlength\nwround{10mm}
\setlength\neround{10mm}
\setlength\seround{10mm}
\setlength\swround{10mm}

% thumbtab for Section page
\newcommand{\thumbtab}[2]{
	\iftoggle{print}{
		\begin{tikzpicture}[remember picture, overlay]
		% north west corner
		\fill[white]
			([xshift=-\inmar, yshift=\topmar]current page text area.north west) --
			([xshift=-\inmar, yshift=\topmar-10mm]current page text area.north west)
			[rounded corners=\nwround] --
			([xshift=-\inmar, yshift=\topmar]current page text area.north west) --
			([xshift=-\inmar+10mm, yshift=\topmar]current page text area.north west)
			[sharp corners] --
			cycle;
		% north east corner
		\fill[white]
			([xshift=\outmar, yshift=-#2*\tabwidth-5mm]current page text area.north east)
			[rounded corners=4mm] --
			([xshift=\outmar, yshift=-#2*\tabwidth]current page text area.north east)
			[rounded corners=3mm] --
			([xshift=\outmar-\tabdepth, yshift=-#2*\tabwidth]current page text area.north east)
			[rounded corners=\neround] --
			([xshift=\outmar-\tabdepth, yshift=\topmar]current page text area.north east) --
			([xshift=\outmar-\tabdepth-10mm, yshift=\topmar]current page text area.north east)
			[sharp corners]--
			([xshift=\outmar, yshift=\topmar]current page text area.north east)--
			cycle;
		\draw[color1]
			([xshift=-\inmar, yshift=\topmar]current page text area.north west)
      [rounded corners=\swround] --
			([xshift=-\inmar, yshift=-\botmar]current page text area.south west)
      [rounded corners=\seround] --
			([xshift=\outmar, yshift=-\botmar]current page text area.south east)
			[rounded corners=4mm] --
			([xshift=\outmar, yshift=-#2*\tabwidth]current page text area.north east)
			[rounded corners=3mm] --
			([xshift=\outmar-\tabdepth, yshift=-#2*\tabwidth]current page text area.north east)
			[rounded corners=\neround] --
			([xshift=\outmar-\tabdepth, yshift=\topmar]current page text area.north east)
      [rounded corners=\nwround]--
			cycle;
		\node[
			thumbtabnode,
		]
		(sectionnode) at ([xshift=1\outmar-\tabdepth, yshift=-#2*\tabwidth]current page text area.north east){
			\small\textbf{#1}
		};
		\end{tikzpicture}
	}{}
	% create label for hyperlinks on front page
	\label{thumbtab:#2}
	% create node on back of page
	\AtBeginShipoutNext{\thumbback{#1}{#2}}
}
% node with section name without border
\newcommand{\thumbback}[2]{
	\iftoggle{print}{
		\begin{tikzpicture}[remember picture, overlay]
		\node[
			thumbbacknode,
		]
		(sectionnode) at ([xshift=-1\outmar+\tabdepth, yshift=-#2*\tabwidth]current page text area.north west) {
			\small\textbf{#1}
		};
		\end{tikzpicture}
	}{}
}
% for front page and back page
\newcommand{\thumbwide}{
	\iftoggle{print}{
		\begin{tikzpicture}[remember picture, overlay]
			% north west corner
			\fill[white]
				([xshift=-\inmar, yshift=\topmar]current page text area.north west) --
				([xshift=-\inmar, yshift=\topmar-1cm]current page text area.north west)
				[rounded corners=\nwround] --
				([xshift=-\inmar, yshift=\topmar]current page text area.north west) --
				([xshift=-\inmar+1cm, yshift=\topmar]current page text area.north west)
				[sharp corners] --
				cycle;
			% north east corner
			\fill[white]
				([xshift=\outmar, yshift=\topmar]current page text area.north east) --
				([xshift=\outmar, yshift=\topmar-1cm]current page text area.north east)
				[rounded corners=\neround] --
				([xshift=\outmar, yshift=\topmar]current page text area.north east) --
				([xshift=\outmar-1cm, yshift=\topmar]current page text area.north east)
				[sharp corners] --
				cycle;
			% south east corner
			\fill[white]
				([xshift=\outmar, yshift=-\botmar]current page text area.south east) --
				([xshift=\outmar, yshift=-\botmar+1cm]current page text area.south east)
				[rounded corners=\seround] --
				([xshift=\outmar, yshift=-\botmar]current page text area.south east) --
				([xshift=\outmar-1cm, yshift=-\botmar]current page text area.south east)
				[sharp corners] --
				cycle;
			% frame
			\draw[color1]
				([xshift=-\inmar, yshift=\topmar]current page text area.north west)
        [rounded corners=\swround] --
				([xshift=-\inmar, yshift=-\botmar]current page text area.south west)
        [rounded corners=\seround] --
				([xshift=\outmar, yshift=-\botmar]current page text area.south east)
        [rounded corners=\neround] --
				([xshift=\outmar, yshift=\topmar]current page text area.north east)
        [rounded corners=\nwround] --
				cycle;
		\end{tikzpicture}
	}{}
}
% for all pages that are not front-, back- or section-page
\newcommand{\thumbnar}{
	\iftoggle{print}{
		\begin{tikzpicture}[remember picture, overlay]
		% north west corner
		\fill[white]
			([xshift=-\inmar, yshift=\topmar]current page text area.north west) --
			([xshift=-\inmar, yshift=\topmar-1cm]current page text area.north west)
			[rounded corners=\nwround] --
			([xshift=-\inmar, yshift=\topmar]current page text area.north west) --
			([xshift=-\inmar+1cm, yshift=\topmar]current page text area.north west)
			[sharp corners] --
			cycle;
		% north east corner
		\fill[white]
			([xshift=\outmar, yshift=\topmar]current page text area.north east) --
			([xshift=\outmar, yshift=\topmar-1cm]current page text area.north east) --
			([xshift=\outmar-\tabdepth, yshift=\topmar-1cm]current page text area.north east)
			[rounded corners=\neround] --
			([xshift=\outmar-\tabdepth, yshift=\topmar]current page text area.north east) --
			([xshift=\outmar-\tabdepth-1cm, yshift=\topmar]current page text area.north east)
			[sharp corners] --
			cycle;
		 % frame
		\draw[color1]
			([xshift=-\inmar, yshift=\topmar]current page text area.north west) [rounded corners = \swround] --
			([xshift=-\inmar, yshift=-\botmar]current page text area.south west) [rounded corners = \seround] --
			([xshift=\outmar-\tabdepth, yshift=-\botmar]current page text area.south east) [rounded corners = \neround] --
			([xshift=\outmar-\tabdepth, yshift=\topmar]current page text area.north east) [rounded corners = \nwround]--
			cycle;
		\end{tikzpicture}
	}{}
}

%-----------------------------------------------------------------
% FRONT PAGE
%-----------------------------------------------------------------

\newlength{\chevout} % sets for right side of chevron
\newlength{\chevpoint} % sets point of chevron
\setlength\chevout{\outmar-12mm}
\setlength\chevpoint{\outmar-5mm}
% chevron height is set by tabwidth so it lines up

% creates hyperlinked white chevron with section name
\newcommand{\thumbfront}[2]{
	\begin{tikzpicture}[remember picture,overlay]
	%white chevrons
	\fill[white]
		([xshift=\chevin,
		yshift=-(#2+0.5)*\tabwidth+(\tabwidth/2-2.5mm)
		]current page text area.north east) --
		([xshift=\chevout,
		yshift=-(#2+0.5)*\tabwidth+(\tabwidth/2-2.5mm)
		]current page text area.north east) --
		([xshift=\chevpoint,
		yshift=-(#2+0.5)*\tabwidth
		]current page text area.north east) --
		([xshift=\chevout,
		yshift=-(#2+0.5)*\tabwidth-(\tabwidth/2-2.5mm)
		]current page text area.north east) --
		([
		xshift=\chevin,
		yshift=-(#2+0.5)*\tabwidth-(\tabwidth/2-2.5mm)
		]current page text area.north east) --
		cycle;
	% hyperlinked node for each section
	% uses a number (thumbtab:#2) as label
	\node[
		rectangle,
		anchor=west,
		rotate=0,
		minimum width=20mm,
		minimum height=\tabwidth-5mm,
		hyperref node=thumbtab:#2
	](Procedure) at ([xshift=\chevin, yshift=-(#2+0.5)*\tabwidth]current page text area.north east) {
		\textbf{#1}
	};
	\end{tikzpicture}
}